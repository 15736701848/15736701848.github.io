<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>庞和合的博客</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #0366d6; }
        .btn { padding: 8px 16px; background: #0366d6; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-outline { background: none; border: 1px solid #0366d6; color: #0366d6; }
        .btn-danger { background: #d73a49; }
        .card { background: white; border: 1px solid #e1e4e8; border-radius: 6px; padding: 15px; margin-bottom: 15px; }
        .card h3 { margin-bottom: 8px; }
        .card p { color: #586069; margin-bottom: 10px; }
        .category { display: inline-block; padding: 2px 8px; background: #f1f8ff; color: #0366d6; border-radius: 12px; font-size: 0.85rem; }
        .actions { display: flex; gap: 10px; margin-top: 10px; }
        .editor { display: none; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #e1e4e8; border-radius: 4px; }
        .form-group textarea { min-height: 200px; font-family: monospace; }
        .preview { background: #f6f8fa; padding: 15px; border-radius: 4px; margin-top: 10px; }
        .gist-config { background: #f6f8fa; padding: 15px; border-radius: 6px; margin-top: 20px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #24292e; color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; }
        .loader { text-align: center; padding: 20px; }
        .loader::after { content: ""; display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(3,102,214,0.2); border-radius: 50%; border-top: 3px solid #0366d6; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="logo">庞和合的博客</div>
        <div>
            <button class="btn" id="new-article">写文章</button>
        </div>
    </header>

    <div id="articles">
        <div class="loader"></div>
    </div>

    <div id="editor" class="editor">
        <div class="form-group">
            <label for="title">标题</label>
            <input type="text" id="title">
        </div>
        <div class="form-group">
            <label for="category">分类</label>
            <div style="display: flex; gap: 10px;">
                <select id="category"></select>
                <input type="text" id="new-category" placeholder="新分类" style="flex: 1;">
                <button class="btn" id="add-category">添加</button>
            </div>
        </div>
        <div class="form-group">
            <label for="content">内容 (Markdown)</label>
            <textarea id="content"></textarea>
        </div>
        <div id="preview" class="preview"></div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn" id="save">保存</button>
            <button class="btn btn-outline" id="cancel">取消</button>
        </div>
    </div>

    <div class="gist-config">
        <h3>GitHub Gist配置</h3>
        <div class="form-group">
            <label for="gist-id">Gist ID</label>
            <input type="text" id="gist-id" placeholder="输入您的Gist ID">
        </div>
        <div class="form-group">
            <label for="token">Personal Access Token</label>
            <input type="password" id="token" placeholder="输入GitHub Token">
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn" id="save-config">保存配置</button>
            <button class="btn btn-outline" id="load">加载数据</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // 博客数据结构
        let blogData = {
            articles: [],
            categories: ['技术', '生活', '随笔']
        };

        // 当前编辑的文章
        let currentArticle = null;
        let gistId = localStorage.getItem('gist_id') || '';
        let token = localStorage.getItem('github_token') || '';

        // DOM元素
        const elements = {
            articles: document.getElementById('articles'),
            editor: document.getElementById('editor'),
            title: document.getElementById('title'),
            category: document.getElementById('category'),
            newCategory: document.getElementById('new-category'),
            content: document.getElementById('content'),
            preview: document.getElementById('preview'),
            gistId: document.getElementById('gist-id'),
            token: document.getElementById('token'),
            toast: document.getElementById('toast')
        };

        // 初始化
        function init() {
            // 设置初始值
            elements.gistId.value = gistId;
            elements.token.value = token;
            
            // 事件监听
            document.getElementById('new-article').addEventListener('click', newArticle);
            document.getElementById('save').addEventListener('click', saveArticle);
            document.getElementById('cancel').addEventListener('click', cancelEdit);
            document.getElementById('add-category').addEventListener('click', addCategory);
            document.getElementById('save-config').addEventListener('click', saveConfig);
            document.getElementById('load').addEventListener('click', loadFromGist);
            
            // 内容输入监听
            elements.content.addEventListener('input', updatePreview);
            
            // 尝试加载数据
            if (gistId && token) {
                loadFromGist();
            } else {
                renderArticles();
            }
        }

        // 渲染文章列表
        function renderArticles() {
            if (blogData.articles.length === 0) {
                elements.articles.innerHTML = '<div class="card">暂无文章</div>';
                return;
            }
            
            let html = '';
            blogData.articles.forEach(article => {
                html += `
                    <div class="card" data-id="${article.id}">
                        <h3>${article.title}</h3>
                        <span class="category">${article.category}</span>
                        <p>${article.content.substring(0, 100)}...</p>
                        <div class="actions">
                            <button class="btn edit-btn">编辑</button>
                            <button class="btn btn-danger delete-btn">删除</button>
                        </div>
                    </div>
                `;
            });
            
            elements.articles.innerHTML = html;
            
            // 添加事件监听
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const articleId = this.closest('.card').dataset.id;
                    editArticle(articleId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const articleId = this.closest('.card').dataset.id;
                    deleteArticle(articleId);
                });
            });
        }

        // 渲染分类下拉框
        function renderCategories() {
            elements.category.innerHTML = '';
            blogData.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                elements.category.appendChild(option);
            });
        }

        // 创建新文章
        function newArticle() {
            currentArticle = null;
            elements.title.value = '';
            elements.content.value = '';
            elements.newCategory.value = '';
            renderCategories();
            elements.editor.style.display = 'block';
            elements.articles.style.display = 'none';
            elements.title.focus();
        }

        // 编辑文章
        function editArticle(id) {
            currentArticle = blogData.articles.find(a => a.id === id);
            if (currentArticle) {
                elements.title.value = currentArticle.title;
                elements.content.value = currentArticle.content;
                elements.newCategory.value = '';
                renderCategories();
                elements.category.value = currentArticle.category;
                elements.editor.style.display = 'block';
                elements.articles.style.display = 'none';
                updatePreview();
            }
        }

        // 保存文章
        function saveArticle() {
            const title = elements.title.value.trim();
            const content = elements.content.value.trim();
            const category = elements.category.value;
            
            if (!title || !content) {
                showToast('标题和内容不能为空');
                return;
            }
            
            const now = new Date().toISOString();
            
            if (currentArticle) {
                // 更新现有文章
                currentArticle.title = title;
                currentArticle.content = content;
                currentArticle.category = category;
                currentArticle.updatedAt = now;
            } else {
                // 创建新文章
                blogData.articles.push({
                    id: 'article_' + Date.now(),
                    title,
                    content,
                    category,
                    createdAt: now,
                    updatedAt: now
                });
            }
            
            // 保存到Gist
            saveToGist();
            
            // 返回列表视图
            cancelEdit();
            showToast(currentArticle ? '文章已更新' : '文章已创建');
        }

        // 删除文章
        function deleteArticle(id) {
            if (confirm('确定要删除这篇文章吗？')) {
                blogData.articles = blogData.articles.filter(a => a.id !== id);
                saveToGist();
                renderArticles();
                showToast('文章已删除');
            }
        }

        // 添加分类
        function addCategory() {
            const newCat = elements.newCategory.value.trim();
            if (newCat && !blogData.categories.includes(newCat)) {
                blogData.categories.push(newCat);
                renderCategories();
                elements.category.value = newCat;
                elements.newCategory.value = '';
            }
        }

        // 取消编辑
        function cancelEdit() {
            elements.editor.style.display = 'none';
            elements.articles.style.display = 'block';
            renderArticles();
        }

        // 更新Markdown预览
        function updatePreview() {
            // 按需加载Marked.js
            if (typeof marked === 'undefined') {
                loadMarked();
                return;
            }
            elements.preview.innerHTML = marked.parse(elements.content.value || '输入内容将在这里预览');
        }

        // 加载Marked.js
        function loadMarked() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            script.onload = updatePreview;
            document.head.appendChild(script);
        }

        // 保存配置
        function saveConfig() {
            gistId = elements.gistId.value.trim();
            token = elements.token.value.trim();
            
            if (!gistId || !token) {
                showToast('请填写Gist ID和Token');
                return;
            }
            
            localStorage.setItem('gist_id', gistId);
            localStorage.setItem('github_token', token);
            showToast('配置已保存');
        }

        // 从Gist加载数据
        function loadFromGist() {
            if (!gistId || !token) {
                showToast('请先配置Gist ID和Token');
                return;
            }
            
            elements.articles.innerHTML = '<div class="loader"></div>';
            
            fetch(`https://api.github.com/gists/${gistId}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const content = data.files['blog.json']?.content;
                if (content) {
                    blogData = JSON.parse(content);
                    renderArticles();
                    showToast('数据加载成功');
                } else {
                    showToast('未找到博客数据');
                    renderArticles();
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                showToast('加载失败: ' + error.message);
                renderArticles();
            });
        }

        // 保存数据到Gist
        function saveToGist() {
            if (!gistId || !token) {
                showToast('请先配置Gist ID和Token');
                return;
            }
            
            const content = JSON.stringify(blogData, null, 2);
            const files = {
                'blog.json': {
                    content: content
                }
            };
            
            fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    files: files,
                    description: '个人博客数据'
                })
            })
            .then(response => {
                if (response.ok) {
                    showToast('数据已同步');
                } else {
                    throw new Error('同步失败');
                }
            })
            .catch(error => {
                console.error('Error saving data:', error);
                showToast('同步失败: ' + error.message);
            });
        }

        // 显示消息提示
        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.style.opacity = '1';
            setTimeout(() => {
                elements.toast.style.opacity = '0';
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
